name: Catalog, Flatten and Resolver Tests

on:
  push:
    branches:
      - staging
  pull_request:
    branches:
      - staging

jobs:
  catalog-flatten-resolver-tests:
    name: Run Catalog, Flatten and Resolver Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v3
        with:
          check-latest: true
          go-version: 1.23.x

      - name: Debug - Show Environment
        run: |
          pwd
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          go version
          go env
          find . -name "*_test.go"
      
      - name: Debug - Check and Print 'types' Folder Path
        run: |
          echo "Current working directory: $(pwd)"
            
          if [ -d "types" ]; then
            echo "'types' directory exists at:"
            realpath types
            echo "Contents of 'types' directory:"
            ls -l types
          else
            echo "‚ùå 'types' directory does NOT exist."
            echo "Listing current directory:"
            ls -l
            exit 1
          fi    
        
      - name: Verify Test Files
        run: |
          if [ ! -f "types/catalog_test.go" ]; then
            echo "Error: types/catalog_test.go is missing"
            exit 1
          fi
          if [ ! -f "typeutils/flatten_test.go" ]; then
            echo "Error: typeutils/flatten_test.go is missing"
            exit 1
          fi
          if [ ! -f "typeutils/resolver_test.go" ]; then
            echo "Error: typeutils/resolver_test.go is missing"
            exit 1
          fi

      - name: Run Catalog Tests
        run: go test -v ./types -run TestGetWrappedCatalog

      - name: Run Flatten Tests
        run: go test -v ./typeutils -run TestFlattener

      - name: Run Resolve Tests
        run: go test -v ./typeutils -run TestResolve
